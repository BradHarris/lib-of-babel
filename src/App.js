import React, {
  Component,
} from 'react';
import {BigNumber} from 'bignumber.js';

import './App.css';

const ALPHABET = '$abcdefghijklmnopqrstuvwxyz*()?_@#~0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
const maxBase = ALPHABET.length;
const base = 30;
BigNumber.config({
  ALPHABET,
  POW_PRECISION: 1e+9,
  EXPONENTIAL_AT: 1e+9,
  ROUNDING_MODE: BigNumber.ROUND_FLOOR,
  DECIMAL_PLACES: 300
})

const PAGE_SIZE = 3200;
const maxCombinations = (new BigNumber(base)).exponentiatedBy(PAGE_SIZE);

let directions = [
  {
    name: 'galaxy',
    total: 2000000000000
  },
  {
    name: 'star',
    total: 100000000000
  },
  {
    name: 'planet',
    total: 24
  },
  {
    name: 'country',
    total: 300
  },
  {
    name: 'city',
    total: 5000
  },
  {
    name: 'street',
    total: 10000
  },
  {
    name: 'street direction',
    total: 2
  },
  {
    name: 'address',
    total: 10000
  },
  {
    name: 'floor',
    total: 50
  },
  {
    name: 'suite',
    total: 20
  },
  {
    name: 'shelf unit',
    total: 24
  },
  {
    name: 'shelf',
    total: 20
  },
  {
    name: 'book',
    total: 50
  },
  {
    name: 'page',
    total: 500
  },
];

const pagesInUniverse = directions.reduce(
  (result, direction) => result.multipliedBy(direction.total),
  new BigNumber(1)
);

const totalUniverses = maxCombinations.dividedBy(pagesInUniverse);
directions.unshift({
  name: 'universe',
  total: totalUniverses
});

let current = maxCombinations;
directions.forEach((direction) => {
  direction.sectionSize = current.dividedToIntegerBy(direction.total);
  current = direction.sectionSize;
});

console.table(
  directions.map((direction) => ({
    ...direction,
    total: direction.total.toString(),
    sectionSize: direction.sectionSize.toString()
  }))
);

const characterMapping = [
  {
    left: ' ',
    leftRegExp: / /g,
    right: '$',
    rightRegExp: /\$/g,
  },
  {
    left: '.',
    leftRegExp: /\./g,
    right: '*',
    rightRegExp: /\*/g,
  },
  {
    left: ',',
    leftRegExp: /,/g,
    right: '(',
    rightRegExp: /\(/g,
  },
  {
    left: '?',
    leftRegExp: /\?/g,
    right: ')',
    rightRegExp: /\)/g,
  },
];


const encode = (val) => {
  return characterMapping.reduce(
    (result, {leftRegExp, right}) => result.replace(leftRegExp, right),
    safeString(val.substring(0, PAGE_SIZE))
  ).padEnd(PAGE_SIZE);
};

const decode = (val) => {
  return characterMapping.reduce(
    (result, {left, rightRegExp}) => result.replace(rightRegExp, left),
    val
  );
};

const safeString = (val) => {
  return val
    .toLowerCase()
    .replace(/[^a-z ?,.]/g, '');
}

const largeDefault = '????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????';

class App extends Component {
  state = {
    value: largeDefault,
    num: new BigNumber(encode(largeDefault), base)
  }

  onChange = (e) => {
    const value = e.target.value;

    const encoded = encode(value);
    const num = new BigNumber(encoded, base);

    this.setState({
      value,
      num
    });
  }

  search = () => {
    const {num} = this.state;

    let current = num;
    const direction = directions.map(({name, total, sectionSize}) => {
      const c = current.toString();
      const position = current.dividedToIntegerBy(sectionSize);
      current = current.modulo(sectionSize);

      const pos = position.toString(maxBase);
      console.log(name, pos, pos.length);

      return {
        c,
        s: sectionSize.toString(),
        p: position.toString(),
        t: total.toString(),
        name,
        position,
        total,
        sectionSize
      };
    });

    const doubleCheck = direction.reverse().reduce((result, {position, sectionSize}) => {
      const n = (new BigNumber(position)).multipliedBy(sectionSize);

      return result.plus(n);
    }, new BigNumber(0));

    console.log(decode(doubleCheck.toString(base)));

    console.table(direction);
  }

  decodeChanged = (e) => {
    const num = new BigNumber(e.target.value, maxBase);
    const backToString = decode(num.toString(base));

    this.setState({
      value: backToString,
      num
    });
  }

  render() {
    const {
      value,
      num
    } = this.state;

    const backToString = decode(num.toString(base));
    const hex = num.toString(maxBase);

    let current = num;
    return (
      <div className="App">
        <header className="App-header">
          <textarea
            value={value}
            onChange={this.onChange}
            cols={140}
            rows={30}
          />
          <div>{value.length}</div>
          <div>{encode(value)}</div>
          <button
            onClick={this.search}
          >
            Search
          </button>

          <input
            type='text'
            value={'test'}
            onChange={() => {}}
          />
          {
            // directions.map((direction) => (
            //   <input
            //     type='text'
            //     value={current}
            // ))
          }
          <textarea
            value={hex}
            onChange={this.decodeChanged}
            cols={140}
            rows={30}
          />
          <div>{hex.length}</div>

          <div>
            {backToString}
          </div>

        </header>
      </div>
    );
  }
}

export default App;
